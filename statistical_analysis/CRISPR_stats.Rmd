---
title: 'Statistical analysis for: Viral diversity is an obligate consideration in
  CRISPR/Cas9 designs for HIV cure.'
output:
  pdf_document: 
    keep_tex: true
editor_options:
  chunk_output_type: inline
---

<!---
Program Name: Viral diversity is an obligate consideration in CRISPR/Cas9 designs for HIV cure. (Roychudbury et al.)
Creation Date: 2017-12-12
Code Author: Bryan Mayer
Project or Protocol: CRISPR (Pavitra Project 2017)
Purpose or description of program: Statistical analysis
Location of program: VIDD-Schiffer shared drive
Location of input data:  VIDD-Schiffer shared drive
--->

## Methods

The goal of this analysis was to test whether targeting percentages vary by the consensus strain used to create the guides. All analyses was done in R (code provided below). To test whether there were overall differences in mean of target percentages, a mixed model was fit with target percentage as the outcome and the consensus strain as the predictors (`lme4` package). A random intercept for each subject by consensus strain was estimated to account for within subject and group variation across the repeated measures. An overall group test (testing whether any mean difference is significantly different than 0) was performed using ANOVA for mixed models using the `lmerTest` package. Post-hoc pairwise comparisons were performed using general linear hypothesis testing for mixed models generated by the `multcomp` and `lsmeans` packages. Adjustment for multiple testing used the Sidak single step method from the `multtest` package (proc = "SidakSS"). 

## Citations

- lsmeans: 
```{r, echo = F, results="asis"}
print(citation("lsmeans"), style = "text")
```

- multcomp: 
```{r, echo = F, results="asis"}
print(citation("multcomp"), style = "text")
```

- lme4: 
```{r, echo = F, results="asis"}
print(citation("lme4"), style = "text")
```

- lmerTest: 
```{r, echo = F, results="asis"}
print(citation("lmerTest"), style = "text")
```


- multtest: 
```{r, echo = F, results="asis"}
print(citation("multtest"), style = "text")
```

\clearpage

## R code

### Data read in

```{r load_libraries}

suppressPackageStartupMessages({
  library(broom)
  library(lmerTest) # mixed models
  library(multcomp) # statistical tests
  library(tidyverse) # data manipulation and plots
  library(knitr)
  library(kableExtra)
  theme_set(theme_bw())
})

opts_chunk$set(tidy = TRUE, cache = TRUE, messages = FALSE, warning = FALSE, echo = FALSE)

dat_all = read_csv(file = "All_pts_matches_highcov.csv") %>%
  group_by(patient, gseq) %>%
  mutate(
    total_consensus = n_distinct(from_consensus),
    groupings = paste(unique(from_consensus), collapse = ","),
    range_pct = diff(range(tgt_match_perc_exact)),
    conserved = total_consensus >= 2
    )

```

\clearpage

### Analysis and models

```{r summary, echo = T}

summary = dat_all %>%
  group_by(from_consensus, patient) %>%
  summarize(
    n = n(),
    mean_match = mean(tgt_match_perc_exact)
  ) %>% group_by(from_consensus) %>%
  summarize(
    patients = n_distinct(patient),
    total_targets = sum(n),
    mean_pct = paste0(round(100 * mean(mean_match), 1), "%")
  )

```


```{r lmm, echo = T, message=F}

### mixed model - pooled con group ###

dat_all$new_var = with(dat_all, ifelse(from_consensus == "patient", "patient", "pooled"))
lmm_pool = lmer(tgt_match_perc_exact ~ new_var + (from_consensus|patient), data = dat_all)

pooled_results = data.frame(
  Model = "Pooled", 
  lhs = "Pooled groups - patient"
  )
pooled_results$estimate = coef(summary(lmm_pool))["new_varpooled", "Estimate"]
pooled_results$pvalue_unadjusted = coef(summary(lmm_pool))["new_varpooled", "Pr(>|t|)"]
  
### mixed model - separate by con groups ###

lmm = lmer(tgt_match_perc_exact ~ from_consensus + (from_consensus|patient), data = dat_all)

ph_tests = summary(glht(lmm, lsmeans::lsm(pairwise~from_consensus)),
             test = adjusted("none")) %>% 
  tidy() %>%
  select(lhs, estimate, p.value) %>% 
  rename(pvalue_unadjusted = p.value)

# Overall F-test
grp_test = anova(lmm)$`Pr(>F)`

### combine results and adjust p-values ###

all_results = bind_rows(pooled_results, ph_tests %>% mutate(Model = " "))

all_results$pvalue_adjusted = multtest::mt.rawp2adjp(all_results$pvalue_unadjusted, 
                                                     proc = "SidakSS")$adjp[,2]



```

\clearpage

```{r results_table}

results_tab = all_results %>% rename(mean_difference = estimate) %>%
  mutate(
    Comparison = paste0(lhs, " = 0"),
    `Mean diff. (%)` = paste0(round(mean_difference * 100, 2), "%"),
    `Adj. p-value (unadj.)` = 
      paste0(round(pvalue_adjusted, 3), " (", round(pvalue_unadjusted, 3), ")")) %>%
  select(Model, Comparison, `Mean diff. (%)`, `Adj. p-value (unadj.)`) 

#for sorting
results_tab_grp = results_tab %>%
  subset(!grepl("patient", Comparison)) %>%
  arrange(Comparison)
results_tab_patient = results_tab %>%
  subset(grepl("patient", Comparison)) %>%
  arrange(Comparison)

kable(summary, caption = "Summary of data.",
            format = "latex", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped"))

kable(bind_rows(results_tab_grp, results_tab_patient), 
      caption = paste0("Mixed model results: post-hoc comparisons (p-values corrected using single-step method). Overall group test (at least one group is different) (p = ", round(grp_test, 3), ")"), 
      digits = 4, format = "latex", booktabs = T, linesep = "") %>%
  kable_styling(latex_options = c("striped")) %>%
  collapse_rows(1, latex_hline = "major")

```



```{r lmm_sub, eval = F}

# this analysis excludes the patient group

dat = subset(dat_all,  from_consensus != "patient") %>%
  group_by(patient, gseq) %>%
  mutate(
    total_consensus = n_distinct(from_consensus),
    groupings = paste(unique(from_consensus), collapse = ","),
    range_pct = diff(range(tgt_match_perc_exact)),
    conserved = total_consensus >= 2
    )

lmm_sub = lmer(tgt_match_perc_exact ~ from_consensus + (from_consensus|patient), data = dat)

ph_tests_sub = summary(glht(lmm_sub, linfct = mcp(from_consensus = "Tukey")), test = adjusted("none")) %>% tidy() %>%
  select(lhs, p.value) %>% rename(pvalue_unadjusted = p.value)
ph_tests_adj_sub = summary(glht(lmm_sub, linfct = mcp(from_consensus = "Tukey")), test = adjusted("single-step")) %>% tidy() %>%
  left_join(ph_tests_sub, by = "lhs")

grp_test_sub = anova(lmm_sub)$`Pr(>F)`

results_tab_sub = ph_tests_adj_sub %>% rename(pvalue = p.value, mean_difference = estimate) %>%
  mutate(comparison = paste0(lhs, " == 0")) %>%
  select(comparison, mean_difference, pvalue, pvalue_unadjusted)


kable(results_tab_sub,  
      caption = paste0("Post-hoc comparisons (p-values corrected using single-step method) for the consensus strains only. Overall group test (at least one group is different) (p = ", grp_test_sub, ")"), digits = 4)

```

\clearpage

### Version information

```{r reproducibility, results="asis"}
suppressMessages({
  library(multtest)
  library(lsmeans)
  library(data.table)
  })

my_session_info <- devtools::session_info()

platform <- my_session_info[[1]]
packages <- my_session_info[[2]]

# TABLE 1
my_session_info1 <- data.table::data.table(
  name = names(platform),
  value = matrix(unlist(platform), nrow = length(platform)))

my_current_input <- ifelse(is.null(ci <- knitr::current_input()), 'No Input File Detected', ci)

file_name <-  data.table::data.table(
  name = 'file name',
  value = my_current_input)

gitremote <-  substr(remote <- system("git remote -v", intern = TRUE)[1],
                     regexpr("\t", remote) + 1,
                     regexpr(" ", remote) - 1)


# Git Remote connection, so getting url and path
all_git_files <- system('git ls-files -co --no-empty-directory --full-name', intern = TRUE)
folder_info_in <- sub(paste0('/', my_current_input), '',
                        all_git_files[grep(my_current_input, all_git_files)])

  if(length(folder_info_in)==0){
    folder_info_in <- 'No Location Detected'
  } else {
    folder_info_in <- folder_info_in[sapply(folder_info_in,
                                            function(x){length(grep(x, getwd())) == 1})]
    }
  
  # Dropping matching file names that do not match folder path
  folder_info <- data.table(
    name = 'location',
    value = "https://github.com/proychou/CRISPR")
  url_info <- data.table::data.table(
    name = 'repo',
    value = "https://github.com/proychou/CRISPR")

  my_session_info1 <- data.table::rbindlist(list(my_session_info1, url_info, folder_info, file_name))

kable(my_session_info1,
               caption = 'Reproducibility Software Session Information', 
      booktabs = T, format = "latex", linesep = "") %>%
  kable_styling(latex_options = "hold_position", font_size = 7)

```

```{r supp2}

# TABLE 2
my_session_info2 <- data.table::data.table(
  matrix(unlist(packages), ncol = length(packages))
  )[V2=='*'][, V2 := NULL] # Only want attached packages
data.table::setnames(my_session_info2, c(paste('V', c(1, 3, 4, 5), sep = '')), names(packages)[-2])

# Adding in Data Versions
if(nrow(my_session_info2)>0){
  my_session_info2[, data.version := as.character(packageDescription(package, fields = 'DataVersion')), by = package]
}

if(my_session_info2[, all(is.na(data.version))]){
  my_session_info2 <- my_session_info2[, .(package, version, date, source)]
} else {
  my_session_info2[is.na(data.version), data.version := '']
  setcolorder(my_session_info2, c('package', 'version', 'data.version', 'date', 'source'))
}

# if this is a vignette in a package, add the data package without loading it
if(grepl("vignettes", getwd()) & file.exists('../DESCRIPTION')){
  thisRow <- my_session_info2[1]
  rd <- roxygen2:::read.description("../DESCRIPTION")
  thisRow[,
          `:=`(package = rd$Package,
               version = rd$Version,
               `data version` = rd$DataVersion,
               date = rd$Date,
               source = url_info$value)]

# if local repo path is too long, break it into two lines
# (this assumes that it doesn't need to wrap to 3 lines)
if(nchar(thisRow$source) > 60){
  slashes <- gregexpr("/", thisRow$source, fixed=TRUE)[[1]]
  p1 <- substr(thisRow$source, 1, slashes[which(slashes>30)][1])
  p2 <- substr(thisRow$source, slashes[which(slashes>30)][1]+1, 500)
  newsource <- gsub("_", "\\_", paste0(p1, " \\\\ \n", p2), fixed=TRUE)
  thisRow$source <- paste0("\\parbox[t]{3in}{", newsource, "}")
}

my_session_info2 <- rbindlist(list(my_session_info2, thisRow), use.names=TRUE, fill=TRUE)
setcolorder(my_session_info2, c('package', 'version', 'data version', 'date', 'source'))
}

kable(my_session_info2, caption = ' Reproducibility Software Package Version Information', booktabs = T, format = "latex", linesep = "") %>%
  kable_styling(font_size = 7, latex_options = "hold_position")

```

